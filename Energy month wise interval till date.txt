----monthwise for generator----------
SELECT 
       to_char(start_time, 'MON YYYY') AS mm,
       to_char(start_time, 'MON YYYY') AS monthWise,
       SUM(CASE
               WHEN device_device_id = 5004 AND energyConsumption > 0 THEN energyConsumption
               ELSE 0 END)                                                                                         AS energy_5004,
       SUM(CASE
               WHEN device_device_id = 5005 AND energyConsumption > 0 THEN energyConsumption
               ELSE 0 END)                                                                                         AS energy_5005,
       SUM(CASE
               WHEN device_device_id = 5006 AND energyConsumption > 0 THEN energyConsumption
               ELSE 0 END)                                                                                         AS energy_5006,
       SUM(CASE
               WHEN device_device_id IN (5004, 5005, 5006) AND energyConsumption > 0 THEN energyConsumption
               ELSE 0 END)                                                                                         AS totalEnergy
from (SELECT sl,
                   device_device_id,
                   start_time,
                   end_time,
                   energy_pre_latest_data,
                   energy_max_value,
                   case
                        when sl = 1 then energy_max_value - energy_pre_latest_data
                        else energy_max_value - nvl((LAG(energy_max_value) OVER (PARTITION BY device_device_id ORDER BY device_device_id, sl)),0)
                    end energyConsumption
            FROM (SELECT
                   sl,
                   device_device_id,
                   start_time,
                   end_time,
                   nvl(energy_pre_latest_data,0) energy_pre_latest_data,
                   LAST_VALUE(case
                        when sl = 1 and energy_max_value is null then nvl(energy_pre_latest_data,0)
                        else energy_max_value
                   end IGNORE NULLS)
                   OVER (PARTITION BY device_device_id ORDER BY sl ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) energy_max_value
            FROM (SELECT dtr.sl,
                         dtr.device_device_id,
                         start_time,
                         end_time,
                         LAST_VALUE(max(ehr.ACTIVEENERGYDELIVERED) IGNORE NULLS)
                                    OVER (PARTITION BY device_device_id ORDER BY sl ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) energy_max_value
                  FROM (SELECT d.id device_device_id,
                               d.*,
                               tr.*
                        FROM device_type dt
                                 JOIN device d
                                      ON dt.id = d.device_type_id
                                          AND dt.parent_id = 101
                                          AND d.unit_id = 109
                                          --and d.input_type = 0
                                          AND d.is_active = 1
                                 CROSS JOIN (SELECT LEVEL AS sl,
                                                       TO_TIMESTAMP(
                                                           TO_CHAR(ADD_MONTHS(TO_DATE(:fromYear, 'DD-MM-YYYY'), LEVEL - 1),
                                                                   'DD-MM-YYYY') || ' 12.00.01.000000000 AM',
                                                           'DD-MM-YYYY HH.MI.SS.FF9 AM') AS start_time,
                                                       TO_TIMESTAMP(
                                                           TO_CHAR(ADD_MONTHS(TO_DATE(:fromYear, 'DD-MM-YYYY'), LEVEL),
                                                                   'DD-MM-YYYY') || ' 12.00.00.000000000 AM',
                                                           'DD-MM-YYYY HH.MI.SS.FF9 AM') AS end_time
                                                FROM dual
                                                CONNECT BY LEVEL <= MONTHS_BETWEEN( ADD_MONTHS(TRUNC(TO_DATE(:toYear, 'DD-MM-YYYY'), 'MM'), 1),
                                                                    TRUNC(TO_DATE(:fromYear, 'DD-MM-YYYY'), 'MM'))
                                                                    ) tr) dtr
                           LEFT JOIN emeter_health_reading ehr
                                     ON dtr.id = ehr.device_id
                                         AND ehr.date_time BETWEEN dtr.start_time AND dtr.end_time
                                         AND ehr.date_time <= TO_TIMESTAMP(:toYear || '00:00:00', 'DD-MM-YYYY HH24:MI:SS')
                                         AND ehr.ACTIVEENERGYDELIVERED > 0
                  group by dtr.sl, dtr.device_device_id, start_time, end_time) dmv
                  left join (
                            SELECT *
                            FROM (SELECT device_id,
                                         date_time                                                                                                 previous_latest_date_time,
                                         ACTIVEENERGYDELIVERED                                                                                     energy_pre_latest_data,
                                         ROW_NUMBER() OVER (PARTITION BY device_id ORDER BY device_id, date_time DESC, ACTIVEENERGYDELIVERED DESC) boi_rnk
                                  FROM emeter_health_reading
                                  WHERE date_time < TO_TIMESTAMP(:fromYear || '00:00:01', 'DD-MM-YYYY HH24:MI:SS')
                                    AND ACTIVEENERGYDELIVERED > 0)
                            WHERE boi_rnk = 1
                            ) pd
                            on dmv.device_device_id = pd.device_id))
group by start_time, end_time
order by start_time