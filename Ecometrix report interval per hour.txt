select start_time                                                                                         startTime,
       end_time                                                                                           endTime,
       SUM(CASE WHEN device_device_id = 5019 AND dieConsumption > 0 THEN dieConsumption ELSE 0 END)    AS bioCon_5019,
       SUM(CASE
               WHEN device_device_id IN (5019) AND dieConsumption > 0 THEN dieConsumption
               ELSE 0 END)                                                                             AS bioConTotalEnergy
from (SELECT cd.sl,
             cd.device_device_id,
             start_time,
             end_time,
             case when cd.sl = 1 then cd.diesel_max_value - die_pre_latest_data else die_consumption end dieConsumption
      FROM (SELECT sl,
                   device_device_id,
                   start_time,
                   end_time,
                   diesel_max_value,
                   diesel_max_value -
                   nvl((LAG(diesel_max_value) OVER (PARTITION BY device_device_id ORDER BY device_device_id, sl)),
                       0) die_consumption
            FROM (SELECT dtr.sl,
                         dtr.device_device_id,
                         start_time,
                         end_time,
                         LAST_VALUE(max(dr.DIESEL_CONSUMPTION) IGNORE NULLS)
                                    OVER (PARTITION BY device_device_id ORDER BY sl ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) diesel_max_value
                  FROM (SELECT d.id device_device_id,
                               d.*,
                               tr.*
                        FROM device_type dt
                                 JOIN device d
                                      ON dt.id = d.device_type_id
                                          AND dt.parent_id = 105
                                          AND d.unit_id = 109
                                          and d.input_type = 0
                                          AND d.is_active = 1
                                 CROSS JOIN (SELECT LEVEL                                    sl,
                                                    TO_TIMESTAMP('2025-02-01 01:00' || ':01', 'YYYY-MM-DD HH24:MI:SS') +
                                                    (LEVEL - 1) *
                                                    NUMTODSINTERVAL(60, 'MINUTE')         AS start_time,
                                                    TO_TIMESTAMP('2025-02-01 01:00' || ':00', 'YYYY-MM-DD HH24:MI:SS') +
                                                    LEVEL * NUMTODSINTERVAL(60, 'MINUTE') AS end_time
                                             FROM dual
                                             CONNECT BY LEVEL <=
                                                        (SELECT
                                                             (TO_DATE('2025-03-01 01:00' || ':00', 'YYYY-MM-DD HH24:MI:SS') -
                                                              TO_DATE('2025-02-01 01:00' || ':00', 'YYYY-MM-DD HH24:MI:SS')) *
                                                             1440 AS minute_difference
                                                         FROM dual) / 60) tr) dtr
                           LEFT JOIN device_reading dr
                                     ON dtr.id = dr.device_id
                                         AND dr.date_time BETWEEN dtr.start_time AND dtr.end_time
                                         AND dr.DIESEL_CONSUMPTION > 0
                  group by dtr.sl, dtr.device_device_id, start_time, end_time)) cd
               LEFT JOIN
           (SELECT *
            FROM (SELECT device_id,
                         date_time                                                                                              previous_latest_date_time,
                         DIESEL_CONSUMPTION                                                                                     die_pre_latest_data,
                         ROW_NUMBER() OVER (PARTITION BY device_id ORDER BY device_id, date_time DESC, DIESEL_CONSUMPTION DESC) boi_rnk
                  FROM device_reading
                  WHERE date_time < TO_TIMESTAMP('2025-02-01 01:00' || ':01', 'YYYY-MM-DD HH24:MI:SS')
                    AND DIESEL_CONSUMPTION > 0)
            WHERE boi_rnk = 1) pd
           ON cd.device_device_id = pd.device_id)
group by start_time, end_time
order by start_time